<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/alphardex/aqua.css/dist/aqua.min.css">
<style>
  body {
    margin: 0;
    overflow: hidden;
  }

  #sketch {
    width: 100vw;
    height: 100vh;
    background: black;
  }
</style>
<div id="sketch"></div>
<div id="tmpl"></div>
<script src="https://unpkg.com/kokomi.js@1.9.36/build/kokomi.umd.js"></script>
<script src="https://unpkg.com/three@0.143.0/build/three.min.js"></script>
<script src="https://unpkg.com/gsap@3.10.4/dist/gsap.min.js"></script>
<script src="https://unpkg.com/lil-gui@0.17.0/dist/lil-gui.umd.min.js"></script>
<script src="https://unpkg.com/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
<script src="./prepare.js"></script>
<script>
  const joinLine = (arr) => arr.join("\n");

  const sketchCreator = `
const createSketch = () => {
  const sketch = new Sketch();
  sketch.create();

  sketch.record = () => {
    let capturer = new CCapture({
      format: "gif",
      workersPath: "../../vendors/",
    });
    let isRecording = false;
    window.addEventListener("keydown", (e) => {
      if (e.key === " ") {
        if (!isRecording) {
          capturer.start();
          isRecording = true;
        } else {
          capturer.stop();
          isRecording = false;
          capturer.save();
        }
      }
    });

    sketch.update(() => {
      if (isRecording) {
        if (sketch.composer){
          sketch.composer.render(sketch.scene, sketch.camera);
        } else {
          sketch.renderer.render(sketch.scene, sketch.camera);
        }
        capturer.capture(sketch.renderer.domElement);
      }
    });
  }

  sketch.record();

  return sketch;
};

const sketch = createSketch();
    `

  const kokomiImport = `import * as kokomi from "kokomi.js";`
  const threeImport = `import * as THREE from "three";`;
  const gsapImport = `import gsap from "gsap";`;
  const lilImport = `import * as dat from "lil";`;
  const lilAlias = `let dat = lil;`;

  const fetchText = (url) => fetch(url).then((res) => res.text())

  const init = async () => {
    await prepare();
    const tmplHTML = await fetchText(`./tmpl.html?v=${Math.random()}`);
    document.querySelector("#tmpl").innerHTML = tmplHTML;
    const vertText = await fetchText(`./vert.glsl?v=${Math.random()}`);
    const vertScript = `const vertexShader = \`${vertText}\`;`;
    const fragText = await fetchText(`./frag.glsl?v=${Math.random()}`);
    const fragScript = `const fragmentShader = \`${fragText}\`;`;
    const res = await fetchText(`./sketch.js?v=${Math.random()}`);
    const s = document.createElement("script");
    let result = joinLine([res, sketchCreator]);
    result = result.replace(kokomiImport, "");
    result = result.replace(threeImport, "");
    result = result.replace(gsapImport, "");
    result = result.replace(lilImport, "");
    result = joinLine([vertScript, result]);
    result = joinLine([fragScript, result]);
    result = joinLine([lilAlias, result]);
    s.textContent = result;
    document.documentElement.appendChild(s);
  }

  init();
</script>